{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">Available Jobs</h1>

<div id="job-list">
    {% for job in jobs %}
        <div class="card mb-3" id="job-{{ job.id }}">
            <div class="card-body">
                <h5 class="card-title">{{ job.title }} - {{ job.company }}</h5>
                <p class="card-text">{{ job.description|truncatewords:20 }}</p>
                <p><strong>Location:</strong> {{ job.location }}</p>

                {% if user.is_authenticated %}
                    <button class="btn btn-success apply-btn" data-job-id="{{ job.id }}">Apply for Job</button>
                {% else %}
                    <a href="{% url 'login' %}" class="btn btn-primary">Login to Apply</a>
                {% endif %}

                <a href="{% url 'job_detail' job.id %}" class="btn btn-info">View Details</a>
            </div>
        </div>
    {% empty %}
        <p>No jobs available yet.</p>
    {% endfor %}
</div>

<script>
const csrftoken = '{{ csrf_token }}';

document.querySelectorAll('.apply-btn').forEach(button => {
    button.addEventListener('click', async function() {
        const jobId = this.dataset.jobId;
        const coverNote = prompt("Enter your cover note for this application:");

        if (!coverNote) return alert("Cover note is required!");

        const data = {
            job: jobId,
            applicant_name: "{{ user.get_full_name }}",
            applicant_email: "{{ user.email }}",
            cover_note: coverNote
        };

        const response = await fetch("{% url 'api_apply_job' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert("Application submitted successfully!");
            this.disabled = true; // disable button after apply
            this.innerText = "Applied";
        } else {
            const error = await response.json();
            alert("Error: " + JSON.stringify(error));
        }
    });
});
</script>
{% endblock %}
